name: Build images
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:
    paths-ignore:
    - '.circleci/**'
    - 'docs/**'
    - 'test/**'

env:
  BIOCONDA_UTILS_FOLDER: bioconda-utils
  DEBIAN_VERSION: "12.2"
  BUSYBOX_VERSION: "1.36.1"
  BASE_TAGS: "0.1.1 latest"
  BUILD_ENV_IMAGE_NAME: tmp-build-env
  CREATE_ENV_IMAGE_NAME: tmp-create-env
  BASE_DEBIAN_IMAGE_NAME: tmp-debian
  BASE_BUSYBOX_IMAGE_NAME: tmp-busybox


jobs:
  build:
    name: Build image
    runs-on: ubuntu-20.04
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - id: get-tag
      run: |
        tag=${{ github.event.release && github.event.release.tag_name || github.sha }}
        printf %s "tag=${tag#v}" >> $GITHUB_OUTPUT

    - name: Install qemu dependency
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-user-static

    - name: Build base-debian
      run: |
        IMAGE_NAME=$BASE_DEBIAN_IMAGE_NAME \
        IMAGE_DIR=../../images/base-glibc-debian-bash \
        ARCHS="amd64 arm64" \
        TYPE="base-debian" \
        DEBIAN_VERSION=$DEBIAN_VERSION \
        TAGS=$BASE_TAGS \
        ./generic_build.bash

    - name: Build base-busybox
      run: |
          IMAGE_NAME=$BASE_BUSYBOX_IMAGE_NAME \
          IMAGE_DIR=../../images/base-glibc-busybox-bash \
          ARCHS="amd64 arm64" \
          TYPE="base-busybox" \
          DEBIAN_VERSION=$DEBIAN_VERSION \
          BUSYBOX_VERSION=$BUSYBOX_VERSION \
          TAGS=$BASE_TAGS \
          ./generic_build.bash

