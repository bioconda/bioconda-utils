name: Build images
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  pull_request:
    paths-ignore:
    - '.circleci/**'
    - 'docs/**'
    - 'test/**'

env:
  BIOCONDA_UTILS_FOLDER: bioconda-utils
  DEBIAN_VERSION: "12.2"
  BUSYBOX_VERSION: "1.36.1"
  BASE_TAGS: "0.1.1 latest"
  BUILD_ENV_IMAGE_NAME: tmp-build-env
  CREATE_ENV_IMAGE_NAME: tmp-create-env
  BASE_DEBIAN_IMAGE_NAME: tmp-debian
  BASE_BUSYBOX_IMAGE_NAME: tmp-busybox
  ARCHS: "amd64 arm64"

jobs:

  # NOTE: base-debian can be a separate job since it is independent of the
  # others. create-env depends on build-env, and both depend on base-busybox,
  # so we can't split that out.
  build-debian:
    name: Build base-debian
    runs-on: ubuntu-20.04
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install qemu dependency
      run: |
        sudo apt-get update
        sudo apt-get install -y qemu-user-static

    - name: Build base-debian
      run: |
        IMAGE_NAME=$BASE_DEBIAN_IMAGE_NAME \
        IMAGE_DIR=images/base-glibc-debian-bash \
        TYPE="base-debian" \
        DEBIAN_VERSION=$DEBIAN_VERSION \
        ARCHS=$ARCHS \
        TAGS=$BASE_TAGS \
        ./generic_build.bash

    - name: Build base-busybox
      run: |
        IMAGE_NAME=$BASE_BUSYBOX_IMAGE_NAME \
        IMAGE_DIR=images/base-glibc-busybox-bash \
        TYPE="base-busybox" \
        ARCHS=$ARCHS \
        DEBIAN_VERSION=$DEBIAN_VERSION \
        BUSYBOX_VERSION=$BUSYBOX_VERSION \
        TAGS=$BASE_TAGS \
        ./generic_build.bash

